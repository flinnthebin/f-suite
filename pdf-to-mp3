#!/usr/bin/env sh

if [ $# -lt 1 ]; then
  echo "Usage: $0 <PDF file>"
  exit 1
fi

PDF_FILE="$1"

if [ ! -f "$PDF_FILE" ]; then
  echo "File not found: $PDF_FILE"
  exit 1
fi

# Base names
BASENAME="${PDF_FILE%.pdf}"
TXT_FILE="${BASENAME}.txt"
FINAL_AUDIO="${BASENAME}.mp3"

WORKDIR=".audiobook"

mkdir -p "$WORKDIR"

pdftotext "$PDF_FILE" "$TXT_FILE"
if [ $? -ne 0 ]; then
  echo "Error extracting text with pdftotext."
  exit 1
fi

split -l 1000 "$TXT_FILE" "${WORKDIR}/chunk_"
if [ $? -ne 0 ]; then
  echo "Error splitting text file."
  exit 1
fi

for CHUNK in "${WORKDIR}"/chunk_*; do
  CHUNK_MP3="${CHUNK}.mp3"
  echo "Processing $CHUNK..."
  gtts-cli -f "$CHUNK" -o "$CHUNK_MP3"
  if [ $? -ne 0 ]; then
    echo "Error generating audio for $CHUNK."
    exit 1
  fi
done

MP3_LIST="${WORKDIR}/mp3_files.txt"
: > "$MP3_LIST"

for CHUNK_MP3 in "${WORKDIR}"/chunk_*.mp3; do
  echo "file '$(pwd)/${CHUNK_MP3}'" >> "$MP3_LIST"
done

COMBINED_MP3="${WORKDIR}/combined.mp3"
ffmpeg -f concat -safe 0 -i "$MP3_LIST" -c copy "$COMBINED_MP3"
if [ $? -ne 0 ]; then
  echo "Error concatenating audio files."
  exit 1
fi

ffmpeg -i "$COMBINED_MP3" -filter:a "atempo=1.5" -vn "$FINAL_AUDIO"
if [ $? -ne 0 ]; then
  echo "Error adjusting audio speed."
  exit 1
fi

rm -rf "$WORKDIR"
rm "$TXT_FILE"

echo "$FINAL_AUDIO successfully generated!"

